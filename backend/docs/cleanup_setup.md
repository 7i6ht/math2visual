# Periodic Cleanup Setup

This document explains how to set up periodic cleanup of temporary files generated by the Math2Visual API.

## Overview

The Math2Visual API generates temporary SVG files for each request using unique UUIDs to prevent conflicts in parallel requests. These files are not cleaned up immediately after the response to avoid blocking the API. Instead, a periodic cleanup job removes old files.

## Files

- `app/utils/cleanup.py` - Cleanup utility classes and functions
- `scripts/cleanup_temp_files.py` - CLI script for manual or scheduled cleanup
- `docs/cleanup_setup.md` - This documentation

## Manual Cleanup

You can run the cleanup script manually:

```bash
# Clean up files older than 24 hours (default)
cd backend
python scripts/cleanup_temp_files.py

# Clean up files older than 1 hour
python scripts/cleanup_temp_files.py --age-hours 1

# Dry run to see what would be cleaned
python scripts/cleanup_temp_files.py --dry-run

# Show storage statistics
python scripts/cleanup_temp_files.py --stats
```

## Automated Cleanup (Cron)

To set up automated cleanup, add a cron job:

### 1. Edit crontab
```bash
crontab -e
```

### 2. Add cleanup job
```bash
# Clean up every 6 hours, files older than 24 hours
0 */6 * * * cd /path/to/math2visual/backend && python scripts/cleanup_temp_files.py --age-hours 24 >> /var/log/math2visual_cleanup.log 2>&1

# Or clean up daily at 2 AM, files older than 12 hours
0 2 * * * cd /path/to/math2visual/backend && python scripts/cleanup_temp_files.py --age-hours 12 >> /var/log/math2visual_cleanup.log 2>&1
```

### 3. Make script executable (optional)
```bash
chmod +x backend/scripts/cleanup_temp_files.py
```

## Configuration

### File Patterns Cleaned
By default, the cleanup removes files matching these patterns:
- `formal_*-*-*-*-*.svg` - Temporary formal visualization files (formal_{uuid}.svg)
- `intuitive_*-*-*-*-*.svg` - Temporary intuitive visualization files (intuitive_{uuid}.svg)

### Age Threshold
- Default: 24 hours
- Configurable via `--age-hours` parameter
- Files older than this threshold are removed

### Archive Files
Archive files are only created when running in **debug mode** (`FLASK_DEBUG=true`):
- `formal_{timestamp}_{uuid}.svg`
- `intuitive_{timestamp}_{uuid}.svg`

To include archive files in cleanup, use the `--include-archives` flag:
```bash
python scripts/cleanup_temp_files.py --include-archives
```

This will also clean up:
- `formal_*_*-*-*-*-*.svg` - Archive formal files (formal_{timestamp}_{uuid}.svg)
- `intuitive_*_*-*-*-*-*.svg` - Archive intuitive files (intuitive_{timestamp}_{uuid}.svg)

## Monitoring

### Check Storage Usage
```bash
python scripts/cleanup_temp_files.py --stats
```

### View Cleanup Logs
```bash
tail -f /var/log/math2visual_cleanup.log
```

### Manual Verification
```bash
# Check what files exist
ls -la storage/output/

# Check file ages
find storage/output/ -name "*.svg" -type f -exec ls -la {} \;
```

## Troubleshooting

### Permission Issues
If cleanup fails due to permissions:
```bash
# Ensure the cleanup script can write to the output directory
chmod 755 storage/output/
chown -R www-data:www-data storage/output/  # Adjust user/group as needed
```

### Disk Space Issues
If storage is filling up:
1. Reduce the age threshold: `--age-hours 6`
2. Run cleanup more frequently in cron
3. Check for very large files: `find storage/output/ -size +10M`

### Cleanup Not Running
1. Check cron service: `systemctl status cron`
2. Check cron logs: `grep CRON /var/log/syslog`
3. Test script manually: `python scripts/cleanup_temp_files.py --dry-run`

## Performance Impact

- **Minimal**: Cleanup runs outside of API requests
- **Storage efficient**: Prevents disk space issues
- **Non-blocking**: API responses are not delayed by cleanup
- **Configurable**: Age thresholds can be tuned based on usage patterns

## Security Considerations

- Cleanup only removes files matching specific patterns
- Archive files with timestamps are preserved by default
- Cleanup errors are logged but don't affect API functionality
